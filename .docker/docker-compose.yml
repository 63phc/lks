version: '3'

services:

  nginx:
    container_name: phc_lks_${PROFILE}_nginx
    image: nginx:1.17.9-alpine
    restart: always
    depends_on:
      - backend
    volumes:
      - ./static:/static
      - ./media:/media
      - ./nginx.conf.nginx:/etc/nginx/conf.d/default.conf
    env_file: .env
    ports:
      - "${NGINX_PORT}:80"

  redis:
    container_name: phc_lks_${PROFILE}_redis
    image: redis:6.0-rc2-alpine
    restart: always
    env_file: .env
    command: redis-server --requirepass ${REDIS_PASSWORD}

  postgresql:
    container_name: phc_lks_${PROFILE}_postgres
    image: postgres:12.2-alpine
    restart: always
    env_file: .env
    volumes:
      - ./pgdata:/var/lib/postgresql/data

  backend:
    container_name: phc_lks_${PROFILE}_backend
    image: 63phc/lks:${PROFILE}
    build:
      context: ..
      dockerfile: .docker/Dockerfile
    restart: always
    command: bash -c "
      gunicorn src.core.wsgi:application -w 2 -b 0.0.0.0:8000"
    volumes:
      - ./static:/app/static
      - ./media:/app/media
    env_file: .env
    depends_on:
      - postgresql
      - redis

  celery:
    container_name: phc_lks_${PROFILE}_celery
    image: 63phc/lks:${PROFILE}
    restart: always
    command: bash -c "
      celery -A src.core.celery worker --loglevel=info"
    volumes:
      - ./static:/app/static
      - ./media:/app/media
    env_file: .env
    depends_on:
      - postgresql
      - redis

#  flower:
#    container_name: phc_lks_${PROFILE}_flower
#    image: mher/flower
#    command: ["--app src.celery",
#              "--broker=redis://${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/2",
#              "--port=${FLOWER_PORT}",
#              "--basic_auth=${FLOWER_USER}:${FLOWER_PASSWORD}"]
#    depends_on:
#      - redis
#    ports:
#      - "${FLOWER_PORT}:5555"
